<!DOCTYPE html>
<html>
  <head>
      <title>HTML5 Create HTML5 Canvas JavaScript Drawing App Example</title>
      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>
      <style>
      canvas { border: 1px solid #ccc; }
      .outsideWrapper{ 
          /* width:256px; height:256px; */
          position:absolute; top:50px; left:50px; 
          margin:20px 20px; 
          border:1px solid rgb(255, 255, 255);}
      .insideWrapper{ 
          width:100%; height:100%; 
          position:relative;}
      .inputImage{ 
          width:200%; height:200%; 
          position:absolute; top:0px; left:0px;
      }
      .canvasImage{ 
          opacity:0.5;
          position:absolute; top:0px; left:0px;
          background-color: rgba(0, 0, 0, 0);
      }
      </style>
      <script type="text/javascript">
      $( document ).ready(function() {
          
        
        var img = document.getElementById('inputImage');
        var canvasWidth = img.width; var cavasHeight = img.height;
        var outsideWrapper = document.getElementById("wrapper");
        
        var canvas = document.getElementById('canvas');
        canvas.setAttribute('width', canvasWidth);
        canvas.setAttribute('height', cavasHeight);
        if(typeof G_vmlCanvasManager != 'undefined') {
            canvas = G_vmlCanvasManager.initElement(canvas);
        }
        context = canvas.getContext("2d");
        context.globalAlpha = 1

        $('#canvas').mousedown(function(event){
              paint = true;
                mouseX = event.pageX - outsideWrapper.offsetLeft;
                mouseY = event.pageY - outsideWrapper.offsetTop;
              
              addClick(mouseX, mouseY);

              redraw();
            });

        $('#canvas').mousemove(function(e){
              if(paint){
                  mouseX = event.pageX - outsideWrapper.offsetLeft;
                  mouseY = event.pageY - outsideWrapper.offsetTop;
                
                  addClick(mouseX, mouseY, true);
                  redraw();
              
              }
            });

        $('#canvas').mouseup(function(e){
              paint = false;
            });

        $('#canvas').mouseleave(function(e){
              paint = false;
            });

        $('#clear').click(function(){
          clickX.length = 0;
          clickY.length = 0;
          clickDrag.length = 0;
          redraw();
        });

        var clickX = new Array();
        var clickY = new Array();
        var clickDrag = new Array();
        var paint;

        function addClick(x, y, dragging)
        {
          clickX.push(x);
          clickY.push(y);
          clickDrag.push(dragging);
        }

        function redraw(){
          context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas

          context.strokeStyle = "pink";
          context.lineJoin = "round";
          context.lineWidth = 5;

          for(var i=0; i < clickX.length; i++) {        
            context.beginPath();
            if(clickDrag[i] && i){
              context.moveTo(clickX[i-1], clickY[i-1]);
            }else{
              context.moveTo(clickX[i]-1, clickY[i]);
            }
            context.lineTo(clickX[i], clickY[i]);
            context.closePath();
            context.stroke();
          }
      }
    function fillBackground(){
      context.globalCompositeOperation='destination-atop';
      context.fillStyle='black';
      context.globalAlpha=1;
      context.fillRect( 0,0, canvas.width,  canvas.height);
    }
      var btn = document.getElementById("btndownload");
      btn.onclick = function(){
        fillBackground()
        download(canvas, 'jatog.png')
      };

      });
   </script>

   <script>
   function download(canvas, filename) {
    /// create an "off-screen" anchor tag
    var lnk = document.createElement('a'), e;

    /// the key here is to set the download attribute of the a tag
    lnk.download = filename;

    /// convert canvas content to data-uri for link. When download
    /// attribute is set the content pointed to by link will be
    /// pushed as "download" in HTML5 capable browsers
    lnk.href = canvas.toDataURL("image/png;base64");

    /// create a "fake" click-event to trigger the download
    if (document.createEvent) {
      e = document.createEvent("MouseEvents");
      e.initMouseEvent("click", true, true, window,
                      0, 0, 0, 0, 0, false, false, false,
                      false, 0, null);

      lnk.dispatchEvent(e);
    } else if (lnk.fireEvent) {
      lnk.fireEvent("onclick");
    }
    }
   </script>
   </head>
     <body>
        <div class="outsideWrapper" id="wrapper">
            <div class="insideWrapper">
                <img src="car.png" class="coveredImage" id = "inputImage">
                <canvas class="canvasImage" id = "canvas" opacity= 0.5></canvas>
            </div>
        </div>
       <button id="btndownload" >Download</button>
    </body>
 </html>
 